#!/bin/bash
#################################################################
#              This Script Brought to you by                    #
#                        theBluWIz                              #
#                   Happy Transcoding!                          #
#################################################################

# Function to display usage information
show_usage() {
  cat <<EOF
Usage: ImageToWebP <source> <target> [quality] [compression]

Arguments:
  <source>           Path to source image file(s) or directory.
  <target>           Path to save the converted image file(s).
  [quality]          Optional. Quality for the output image (0-100).
  [compression]      Optional. Compression level (0-6).

Examples:
  Basic Conversion:
    ImageToWebP input.jpg output.webp

  Custom Quality and Compression:
    ImageToWebP input.png output.webp 75 4
EOF
}

# Check if no arguments were passed or if the first argument is --help
if [ "$#" -eq 0 ] || [ "$1" == "--help" ]; then
  show_usage
  exit 0
fi

# Function to convert a single file
convert_file() {
  local src_file=$1
  local tgt_file=$2
  local quality=$3
  local compression=$4

  echo "Converting $src_file to $tgt_file"

  ffmpeg -i "$src_file" -qscale:v "$quality" -compression_level "$compression" "$tgt_file"
}

# Function to process a batch of files
process_file_batch() {
  local file=$1
  local source_dir=$2
  local target_dir=$3
  local quality=$4
  local compression=$5

  local relative_path="${file#$source_dir/}"
  local target_file="$target_dir/${relative_path%.*}.webp"
  mkdir -p "$(dirname "$target_file")"
  convert_file "$file" "$target_file" "$quality" "$compression"
}

# Function to process files in a directory
process_files() {
  local source_dir=$1
  local target_dir=$2
  local quality=$3
  local compression=$4

  export -f convert_file
  export -f process_file_batch

  find "$source_dir" -type f \( -iname \*.jpg -o -iname \*.jpeg -o -iname \*.png -o -iname \*.gif -o -iname \*.bmp -o -iname \*.tiff \) -print0 | xargs -0 -n 1 -P 4 -I {} bash -c 'process_file_batch "$@"' _ {} "$source_dir" "$target_dir" "$quality" "$compression"
}

# Check for minimum arguments
if [ "$#" -lt 2 ]; then
  echo "Usage: $0 <Source File or Directory> <Target File or Directory> [Quality (0-100)] [Compression Level (0-6)]"
  exit 1
fi

# Assign arguments to variables
SOURCE=$1
TARGET=$2
QUALITY=${3:-75}  # Default to 75 if not specified
COMPRESSION=${4:-4}  # Default to 4 if not specified

# Debugging output
echo "Source: $SOURCE"
echo "Target: $TARGET"
echo "Quality: $QUALITY"
echo "Compression: $COMPRESSION"

# Check if source is a directory
if [ -d "$SOURCE" ]; then
  echo "Source is a directory. Processing all image files."
  # Create target directory
  mkdir -p "$TARGET"
  # Process files
  process_files "$SOURCE" "$TARGET" "$QUALITY" "$COMPRESSION"
else
  echo "Source is a single file. Processing the file."
  # If source is not a directory, treat it as a single file
  base_name=$(basename "$SOURCE")
  target_file="$TARGET.webp"
  convert_file "$SOURCE" "$target_file" "$QUALITY" "$COMPRESSION"
fi
